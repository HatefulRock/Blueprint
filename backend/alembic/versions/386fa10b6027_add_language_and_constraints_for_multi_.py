"""add_language_and_constraints_for_multi_user_support

Revision ID: 386fa10b6027
Revises: e74342a5cf4a
Create Date: 2026-01-23 14:16:14.773633

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '386fa10b6027'
down_revision: Union[str, None] = 'e74342a5cf4a'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('card_templates', sa.Column('language', sa.String(length=50), nullable=True))
    op.create_index(op.f('ix_card_templates_user_id'), 'card_templates', ['user_id'], unique=False)
    op.drop_constraint(op.f('card_templates_user_id_fkey'), 'card_templates', type_='foreignkey')
    op.create_foreign_key(None, 'card_templates', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_cards_deck_id'), 'cards', ['deck_id'], unique=False)
    op.create_index(op.f('ix_cards_next_review_date'), 'cards', ['next_review_date'], unique=False)
    op.create_index(op.f('ix_cards_word_id'), 'cards', ['word_id'], unique=False)
    op.drop_constraint(op.f('fk_cards_word_id'), 'cards', type_='foreignkey')
    op.drop_constraint(op.f('cards_template_id_fkey'), 'cards', type_='foreignkey')
    op.drop_constraint(op.f('cards_deck_id_fkey'), 'cards', type_='foreignkey')
    op.create_foreign_key(None, 'cards', 'words', ['word_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key(None, 'cards', 'card_templates', ['template_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key(None, 'cards', 'decks', ['deck_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_conversation_messages_session_id'), 'conversation_messages', ['session_id'], unique=False)
    op.drop_constraint(op.f('conversation_messages_session_id_fkey'), 'conversation_messages', type_='foreignkey')
    op.create_foreign_key(None, 'conversation_messages', 'practice_sessions', ['session_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_decks_language'), 'decks', ['language'], unique=False)
    op.create_index(op.f('ix_decks_user_id'), 'decks', ['user_id'], unique=False)
    op.drop_constraint(op.f('decks_user_id_fkey'), 'decks', type_='foreignkey')
    op.create_foreign_key(None, 'decks', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_grammar_exercise_attempts_created_at'), 'grammar_exercise_attempts', ['created_at'], unique=False)
    op.create_index(op.f('ix_grammar_exercise_attempts_exercise_id'), 'grammar_exercise_attempts', ['exercise_id'], unique=False)
    op.create_index(op.f('ix_grammar_exercise_attempts_user_id'), 'grammar_exercise_attempts', ['user_id'], unique=False)
    op.drop_constraint(op.f('grammar_exercise_attempts_exercise_id_fkey'), 'grammar_exercise_attempts', type_='foreignkey')
    op.drop_constraint(op.f('grammar_exercise_attempts_user_id_fkey'), 'grammar_exercise_attempts', type_='foreignkey')
    op.create_foreign_key(None, 'grammar_exercise_attempts', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'grammar_exercise_attempts', 'grammar_exercises', ['exercise_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_grammar_exercise_sets_created_at'), 'grammar_exercise_sets', ['created_at'], unique=False)
    op.create_index(op.f('ix_grammar_exercise_sets_language'), 'grammar_exercise_sets', ['language'], unique=False)
    op.create_index(op.f('ix_grammar_exercise_sets_user_id'), 'grammar_exercise_sets', ['user_id'], unique=False)
    op.drop_constraint(op.f('grammar_exercise_sets_user_id_fkey'), 'grammar_exercise_sets', type_='foreignkey')
    op.drop_constraint(op.f('grammar_exercise_sets_reading_content_id_fkey'), 'grammar_exercise_sets', type_='foreignkey')
    op.create_foreign_key(None, 'grammar_exercise_sets', 'reading_content', ['reading_content_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key(None, 'grammar_exercise_sets', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_grammar_exercises_exercise_set_id'), 'grammar_exercises', ['exercise_set_id'], unique=False)
    op.drop_constraint(op.f('grammar_exercises_exercise_set_id_fkey'), 'grammar_exercises', type_='foreignkey')
    op.create_foreign_key(None, 'grammar_exercises', 'grammar_exercise_sets', ['exercise_set_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_practice_reviews_card_id'), 'practice_reviews', ['card_id'], unique=False)
    op.create_index(op.f('ix_practice_reviews_session_id'), 'practice_reviews', ['session_id'], unique=False)
    op.create_index(op.f('ix_practice_reviews_timestamp'), 'practice_reviews', ['timestamp'], unique=False)
    op.create_index(op.f('ix_practice_reviews_user_id'), 'practice_reviews', ['user_id'], unique=False)
    op.drop_constraint(op.f('practice_reviews_session_id_fkey'), 'practice_reviews', type_='foreignkey')
    op.drop_constraint(op.f('practice_reviews_user_id_fkey'), 'practice_reviews', type_='foreignkey')
    op.drop_constraint(op.f('practice_reviews_card_id_fkey'), 'practice_reviews', type_='foreignkey')
    op.create_foreign_key(None, 'practice_reviews', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'practice_reviews', 'cards', ['card_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key(None, 'practice_reviews', 'practice_sessions', ['session_id'], ['id'], ondelete='CASCADE')
    op.add_column('practice_sessions', sa.Column('language', sa.String(length=50), nullable=True))
    op.create_index(op.f('ix_practice_sessions_language'), 'practice_sessions', ['language'], unique=False)
    op.create_index(op.f('ix_practice_sessions_timestamp'), 'practice_sessions', ['timestamp'], unique=False)
    op.create_index(op.f('ix_practice_sessions_user_id'), 'practice_sessions', ['user_id'], unique=False)
    op.drop_constraint(op.f('practice_sessions_user_id_fkey'), 'practice_sessions', type_='foreignkey')
    op.create_foreign_key(None, 'practice_sessions', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.add_column('reading_content', sa.Column('language', sa.String(length=50), nullable=True))
    op.create_index(op.f('ix_reading_content_language'), 'reading_content', ['language'], unique=False)
    op.create_index(op.f('ix_reading_content_user_id'), 'reading_content', ['user_id'], unique=False)
    op.drop_constraint(op.f('reading_content_user_id_fkey'), 'reading_content', type_='foreignkey')
    op.create_foreign_key(None, 'reading_content', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_word_contexts_word_id'), 'word_contexts', ['word_id'], unique=False)
    op.drop_constraint(op.f('word_contexts_word_id_fkey'), 'word_contexts', type_='foreignkey')
    op.drop_constraint(op.f('word_contexts_reading_content_id_fkey'), 'word_contexts', type_='foreignkey')
    op.create_foreign_key(None, 'word_contexts', 'words', ['word_id'], ['id'], ondelete='CASCADE')
    op.create_foreign_key(None, 'word_contexts', 'reading_content', ['reading_content_id'], ['id'], ondelete='SET NULL')
    op.create_index(op.f('ix_words_deck_id'), 'words', ['deck_id'], unique=False)
    op.create_index(op.f('ix_words_next_review_date'), 'words', ['next_review_date'], unique=False)
    op.create_index(op.f('ix_words_status'), 'words', ['status'], unique=False)
    op.create_index(op.f('ix_words_term'), 'words', ['term'], unique=False)
    op.create_unique_constraint('uq_deck_term', 'words', ['deck_id', 'term'])
    op.drop_constraint(op.f('words_deck_id_fkey'), 'words', type_='foreignkey')
    op.drop_constraint(op.f('fk_words_reading_content'), 'words', type_='foreignkey')
    op.create_foreign_key(None, 'words', 'reading_content', ['reading_content_id'], ['id'], ondelete='SET NULL')
    op.create_foreign_key(None, 'words', 'decks', ['deck_id'], ['id'], ondelete='CASCADE')
    op.create_index(op.f('ix_writing_submissions_created_at'), 'writing_submissions', ['created_at'], unique=False)
    op.create_index(op.f('ix_writing_submissions_language'), 'writing_submissions', ['language'], unique=False)
    op.create_index(op.f('ix_writing_submissions_user_id'), 'writing_submissions', ['user_id'], unique=False)
    op.drop_constraint(op.f('writing_submissions_user_id_fkey'), 'writing_submissions', type_='foreignkey')
    op.create_foreign_key(None, 'writing_submissions', 'users', ['user_id'], ['id'], ondelete='CASCADE')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'writing_submissions', type_='foreignkey')
    op.create_foreign_key(op.f('writing_submissions_user_id_fkey'), 'writing_submissions', 'users', ['user_id'], ['id'])
    op.drop_index(op.f('ix_writing_submissions_user_id'), table_name='writing_submissions')
    op.drop_index(op.f('ix_writing_submissions_language'), table_name='writing_submissions')
    op.drop_index(op.f('ix_writing_submissions_created_at'), table_name='writing_submissions')
    op.drop_constraint(None, 'words', type_='foreignkey')
    op.drop_constraint(None, 'words', type_='foreignkey')
    op.create_foreign_key(op.f('fk_words_reading_content'), 'words', 'reading_content', ['reading_content_id'], ['id'])
    op.create_foreign_key(op.f('words_deck_id_fkey'), 'words', 'decks', ['deck_id'], ['id'])
    op.drop_constraint('uq_deck_term', 'words', type_='unique')
    op.drop_index(op.f('ix_words_term'), table_name='words')
    op.drop_index(op.f('ix_words_status'), table_name='words')
    op.drop_index(op.f('ix_words_next_review_date'), table_name='words')
    op.drop_index(op.f('ix_words_deck_id'), table_name='words')
    op.drop_constraint(None, 'word_contexts', type_='foreignkey')
    op.drop_constraint(None, 'word_contexts', type_='foreignkey')
    op.create_foreign_key(op.f('word_contexts_reading_content_id_fkey'), 'word_contexts', 'reading_content', ['reading_content_id'], ['id'])
    op.create_foreign_key(op.f('word_contexts_word_id_fkey'), 'word_contexts', 'words', ['word_id'], ['id'])
    op.drop_index(op.f('ix_word_contexts_word_id'), table_name='word_contexts')
    op.drop_constraint(None, 'reading_content', type_='foreignkey')
    op.create_foreign_key(op.f('reading_content_user_id_fkey'), 'reading_content', 'users', ['user_id'], ['id'])
    op.drop_index(op.f('ix_reading_content_user_id'), table_name='reading_content')
    op.drop_index(op.f('ix_reading_content_language'), table_name='reading_content')
    op.drop_column('reading_content', 'language')
    op.drop_constraint(None, 'practice_sessions', type_='foreignkey')
    op.create_foreign_key(op.f('practice_sessions_user_id_fkey'), 'practice_sessions', 'users', ['user_id'], ['id'])
    op.drop_index(op.f('ix_practice_sessions_user_id'), table_name='practice_sessions')
    op.drop_index(op.f('ix_practice_sessions_timestamp'), table_name='practice_sessions')
    op.drop_index(op.f('ix_practice_sessions_language'), table_name='practice_sessions')
    op.drop_column('practice_sessions', 'language')
    op.drop_constraint(None, 'practice_reviews', type_='foreignkey')
    op.drop_constraint(None, 'practice_reviews', type_='foreignkey')
    op.drop_constraint(None, 'practice_reviews', type_='foreignkey')
    op.create_foreign_key(op.f('practice_reviews_card_id_fkey'), 'practice_reviews', 'cards', ['card_id'], ['id'])
    op.create_foreign_key(op.f('practice_reviews_user_id_fkey'), 'practice_reviews', 'users', ['user_id'], ['id'])
    op.create_foreign_key(op.f('practice_reviews_session_id_fkey'), 'practice_reviews', 'practice_sessions', ['session_id'], ['id'])
    op.drop_index(op.f('ix_practice_reviews_user_id'), table_name='practice_reviews')
    op.drop_index(op.f('ix_practice_reviews_timestamp'), table_name='practice_reviews')
    op.drop_index(op.f('ix_practice_reviews_session_id'), table_name='practice_reviews')
    op.drop_index(op.f('ix_practice_reviews_card_id'), table_name='practice_reviews')
    op.drop_constraint(None, 'grammar_exercises', type_='foreignkey')
    op.create_foreign_key(op.f('grammar_exercises_exercise_set_id_fkey'), 'grammar_exercises', 'grammar_exercise_sets', ['exercise_set_id'], ['id'])
    op.drop_index(op.f('ix_grammar_exercises_exercise_set_id'), table_name='grammar_exercises')
    op.drop_constraint(None, 'grammar_exercise_sets', type_='foreignkey')
    op.drop_constraint(None, 'grammar_exercise_sets', type_='foreignkey')
    op.create_foreign_key(op.f('grammar_exercise_sets_reading_content_id_fkey'), 'grammar_exercise_sets', 'reading_content', ['reading_content_id'], ['id'])
    op.create_foreign_key(op.f('grammar_exercise_sets_user_id_fkey'), 'grammar_exercise_sets', 'users', ['user_id'], ['id'])
    op.drop_index(op.f('ix_grammar_exercise_sets_user_id'), table_name='grammar_exercise_sets')
    op.drop_index(op.f('ix_grammar_exercise_sets_language'), table_name='grammar_exercise_sets')
    op.drop_index(op.f('ix_grammar_exercise_sets_created_at'), table_name='grammar_exercise_sets')
    op.drop_constraint(None, 'grammar_exercise_attempts', type_='foreignkey')
    op.drop_constraint(None, 'grammar_exercise_attempts', type_='foreignkey')
    op.create_foreign_key(op.f('grammar_exercise_attempts_user_id_fkey'), 'grammar_exercise_attempts', 'users', ['user_id'], ['id'])
    op.create_foreign_key(op.f('grammar_exercise_attempts_exercise_id_fkey'), 'grammar_exercise_attempts', 'grammar_exercises', ['exercise_id'], ['id'])
    op.drop_index(op.f('ix_grammar_exercise_attempts_user_id'), table_name='grammar_exercise_attempts')
    op.drop_index(op.f('ix_grammar_exercise_attempts_exercise_id'), table_name='grammar_exercise_attempts')
    op.drop_index(op.f('ix_grammar_exercise_attempts_created_at'), table_name='grammar_exercise_attempts')
    op.drop_constraint(None, 'decks', type_='foreignkey')
    op.create_foreign_key(op.f('decks_user_id_fkey'), 'decks', 'users', ['user_id'], ['id'])
    op.drop_index(op.f('ix_decks_user_id'), table_name='decks')
    op.drop_index(op.f('ix_decks_language'), table_name='decks')
    op.drop_constraint(None, 'conversation_messages', type_='foreignkey')
    op.create_foreign_key(op.f('conversation_messages_session_id_fkey'), 'conversation_messages', 'practice_sessions', ['session_id'], ['id'])
    op.drop_index(op.f('ix_conversation_messages_session_id'), table_name='conversation_messages')
    op.drop_constraint(None, 'cards', type_='foreignkey')
    op.drop_constraint(None, 'cards', type_='foreignkey')
    op.drop_constraint(None, 'cards', type_='foreignkey')
    op.create_foreign_key(op.f('cards_deck_id_fkey'), 'cards', 'decks', ['deck_id'], ['id'])
    op.create_foreign_key(op.f('cards_template_id_fkey'), 'cards', 'card_templates', ['template_id'], ['id'])
    op.create_foreign_key(op.f('fk_cards_word_id'), 'cards', 'words', ['word_id'], ['id'])
    op.drop_index(op.f('ix_cards_word_id'), table_name='cards')
    op.drop_index(op.f('ix_cards_next_review_date'), table_name='cards')
    op.drop_index(op.f('ix_cards_deck_id'), table_name='cards')
    op.drop_constraint(None, 'card_templates', type_='foreignkey')
    op.create_foreign_key(op.f('card_templates_user_id_fkey'), 'card_templates', 'users', ['user_id'], ['id'])
    op.drop_index(op.f('ix_card_templates_user_id'), table_name='card_templates')
    op.drop_column('card_templates', 'language')
    # ### end Alembic commands ###
